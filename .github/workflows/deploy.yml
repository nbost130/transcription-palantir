name: ðŸš€ Deploy to Production

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Deploy to Mithrandir
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”— Connect to Tailscale
      uses: tailscale/github-action@v2
      with:
        oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
        oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
        tags: tag:ci

    - name: ðŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.MITHRANDIR_SSH_KEY }}

    - name: ðŸ“ Add SSH known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H 100.77.230.53 >> ~/.ssh/known_hosts

    - name: ðŸš€ Deploy to production
      run: |
        ssh nbost@100.77.230.53 << 'ENDSSH'
          set -e

          echo "ðŸ“‚ Navigating to project directory..."
          cd /home/nbost/transcription-palantir

          echo "ðŸ” Checking for divergent branches..."
          git fetch origin

          echo "ðŸ”„ Syncing with GitHub (using reset to handle divergence)..."
          git reset --hard origin/main
          
          echo "ðŸ“¦ Installing dependencies..."
          npm install
          
          echo "ðŸ”¨ Building project..."
          npm run build

          echo "ðŸ§¹ Cleaning up orphaned processes..."
          # Kill any orphaned processes that might be blocking port 9003
          pkill -f 'transcription-palantir/dist/index.js' || true
          sleep 2

          echo "ðŸ”„ Restarting service..."
          sudo systemctl restart transcription-palantir

          echo "â³ Waiting for service to start..."
          sleep 5

          echo "ðŸ” Verifying service is running..."
          # Check systemd service is actually active
          if ! sudo systemctl is-active --quiet transcription-palantir; then
            echo "âŒ Service failed to start"
            sudo systemctl status transcription-palantir --no-pager -l
            exit 1
          fi

          echo "âœ… Verifying deployment health..."
          # Check health endpoint responds
          curl -f http://localhost:9003/api/v1/health || exit 1

          echo "ðŸ• Verifying fresh deployment..."
          # Verify uptime is recent (less than 60 seconds = fresh restart)
          UPTIME=$(curl -s http://localhost:9003/api/v1/health | jq -r '.uptime')
          if (( $(echo "$UPTIME > 60" | bc -l) )); then
            echo "âš ï¸  WARNING: Service appears stale (uptime: ${UPTIME}s)"
            echo "This might indicate the restart failed and old instance is still running"
            exit 1
          fi
          echo "âœ… Service is fresh (uptime: ${UPTIME}s)"
          
          echo "ðŸŽ‰ Deployment successful!"
        ENDSSH
        
    - name: ðŸ” Verify deployment
      run: |
        # Wait a bit more for full startup
        sleep 3
        
        # Check health endpoint
        HEALTH=$(curl -s http://100.77.230.53:9003/api/v1/health | jq -r '.status')
        if [ "$HEALTH" != "ok" ]; then
          echo "âŒ Health check failed: $HEALTH"
          exit 1
        fi
        
        echo "âœ… Deployment verified - service is healthy"
        
    - name: ðŸ“Š Deployment summary
      if: always()
      run: |
        echo "### ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment:** Production (Mithrandir)" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Endpoints:**" >> $GITHUB_STEP_SUMMARY
        echo "- Health: http://100.77.230.53:9003/api/v1/health" >> $GITHUB_STEP_SUMMARY
        echo "- Services: http://100.77.230.53:9003/api/services/health" >> $GITHUB_STEP_SUMMARY
        echo "- Dashboard: http://100.77.230.53:3000/services" >> $GITHUB_STEP_SUMMARY

